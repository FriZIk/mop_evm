# Реалилизация криптоалгоритма "Кузнечик" на ПЛИС

## Титул

### Ледерер П.А., Кочубей Д.С 
### руководитель - к.п.н, доцент Кафедры интеллектуальных и многопроцессорных систем
### Механцев Б.Е. Южный федеральный университет, г. Таганрог

---
## Вступление
На сегодняшний день существует большое количество средств шифрования данных. Их можно разделить на две группы: программные и аппаратные. В данной статье описаны подходы и методы использовавшиеся при аппаратной реализации криптоалгоритма "Кузнечик".

---
## Причины аппратной реализации
Основными приемуществами аппаратной реалзиации криптографических алгоритмов является высокая скорость шифрования по сравнению с программными аналогами. Так же подобные устройства уменьшают нагрузку на компьютер пользователя, так как ресурсоёмкие операции выполняются на специализированной плате расширения. Чаще всего подобные устройства применяются в компаниях и организациях занимающихся работой с большими объёмами конфиденциальной или секретной информации.

---
## Принципы работы криптоалгоритма кузнечик
Криптоалгоритм кузнечик является блочным алгоритмом шифрования. Длинна блока данных составляет 128 бит, ключа шифрования - 256 бит. Работа алгоритма основана на сетях Фейстеля, благодаря этому "Кузнечика" удобно реализовывать аппаратно. 

### Работа алгоритма состоит из следующих этапов:

1. X-функция, побитовое “исключающее или” (далее XOR) блока данных и раундового ключа(генерацию раундового ключа будет разобрана позднее).
2. S-функция, нелинейное преобразование. Побайтовая замена одних значений на другие в соответствии с таблицей констант.
3. L-функция, линейное преобразование. (Позже)

![Схема работы сети Кузнечика](/img/kuz.jpeg)

Эти шаги повторяются на протяжении 9-и раундов, на 10-ом выполняется только X-функция. 

### Генерация раундовых ключей
Процесс генерации раундовых так же основан на сети Фейстеля и во многом последовательность действий аналогична таковой в основном алгоритме, но есть ряд отличий. 

Сначала мастер-ключ(256 бит) делится пополам, будем называть их правой и левой. Этапы создания раундового ключа:
1. X-функция. Происходит побитовый XOR. Левая часть ключа складывается с итерационными константами (заранее рассчитанными, приведём их расчёт позже).
2. S-функция. Выполняется побайтовая замена с левой частью мастер-ключа.
3. L-функция. Нелинейное преобразование, так же над левой частью.
4. Снова X-функция. Последний этап, XOR c правой половиной исходного ключа. Далее правая и левая часть меняются местами.

![Схема работы сети Кузнечика](/img/kuz.jpeg)

Далее мы повторяем X,S,L и X с правой частью 8 раз для получения новой пары ключей (8 раундов сети Фейстеля на каждую пару ключей). На первом раунде генерация раундового ключа не происходит, в качестве раундового ключа используется левая часть master-ключа. На втором раунде мы так же не генерируем ключ, взяв правую часть мастер-ключа, а вот для третьей уже потребуется выполнить 8 итераций сети Фейстеля.

---
## Особенности реализации
Наша реализация алгоритма кузнечик отличается от эталонной описанной в 	ГОСТ 34.12-2018. Было принято решение, для упрощения отладки и симуляции, уменьшить размеры блока данных со 128 до 16 бит и длинну ключа с 256 до 32 бит. Так же было уменьшено количество раундов, у нас их 4 вместо 10. В остальном алгоритм остался неизменным. 

Работа проводилась с отладочной платой Arty A7-35 имеющей ПЛИС(модель – XC7A35TICSG324-1L) на борту. На плате располагается jtag-программатор, 256 мб оперативной памяти, множество GPIO портов и портов расширения для подключения датчиков и других устройств, а так же Ethernet.

---
## Microblaze и ip-ядра
Мозгом системы является soft-процессор Microblaze. По сути своей это 32-ух битный процессор с RISC архитектурой. Он способен обеспечивать связь с периферийными устройствами средствами встроенных шин. На процессоре Microblaze можно запустить ряд операционных систем (Linux, FreeRTOS и тд). При этом программист способен выбирать какие функции процессора ему нужны и при необходимости удалять неиспользуемые для увеличения скорости работы системы.

Логика работы устройства при использовании Microblaze описывается на языках C/C++ в специальном SDK, идущем в комплекте с Vivado. Так же есть возможность подключения к Microblaze специализированных написанных на VHDL блоков (IP-блоков или IP-ядер), для выполнения определённых операций. Именно таким блоком будет наш криптоалгоритм.

Окончательная архитектура системы представленна на иллюстрации 3

![Окончательная архитектура устройства](/img/Microblaze.png)

---
## Окончательные схемы устройства
Как уже было упомянуто ранее "Кузнечик" был написан на языке VHDL. Проектирование и симуляция системы проводилась в IDE Xilinx Vivado. Итоговая схема шифратора и дешифратора, а так же результат симуляционных тестов предстваленны на рисунках №4 №5 и №6 соответсвенно.

![Электронная схема шифратора](/img/)
![Электронная схема дешифратора](/img/)
![Результат симуляционных тестов](/img/)

С исходным кодом проекта можно ознакомится по ссылке: https://github.com/FriZIk/FPGA.

---
## Дальнейшее развитие
Одним из путей дальнейшего улучшения является использование конвеерных вычислений для распараллеливания однотипных задач. Так же в будущем возможно взять ПЛИС семейства Zynq, в них аппартано присутсвует ядро ARM Cortex A9, на которое возможно переложить функции, которые сейчас выполняет Microblaze, тем самым дополнительно увеличив скорость обработки данных.

---
## Список литературы
1. Криптографический алгоритм «Кузнечик»: просто о сложном // Habr
URL: https://habr.com/ru/post/459004
2. Разработка процессорной системы на базе софт-процессора MicroBlaze в среде Xilinx Vivado IDE // fpga-systems URL: https://fpgasystems.ru/publ/xilinx/microblaze/razrabotka_processornoj_sistemy_na_baze_soft_processora_microblaze_v_srede_xilinx_vivado_ide_hlx_chast_2/10-1-0-7
3. Creating a custom IP block in Vivado // fpga-developer URL:
http://www.fpgadeveloper.com/2014/08/creating-a-custom-ip-block-invivado.html
4. П. Н. Бибило Основы языка VHDL. Либроком, 2016.
5. И.И. Левин, Б.Е. Механцев Лабораторные работы по дисциплине
"ПЛИС-технологии и методы создания эффективных прикладных
программ для ПЛИС". Таганрог: Издательство Южного
федерального университета, 2017.
6. Xilinx [Электронный ресурс]. – URL:https://www.xilinx.com/products/silicon-devices.fpga.html (дата обращения: 31.04.2020).
